## 1.安装软件
```sh
# 查看apt-mirror版本
apt policy apt-mirror 
#apt-mirror:
#  Installed: 0.5.1-1ubuntu1
#  Candidate: 0.5.1-1ubuntu1

# 安装apt-mirror
sudo apt-get install apt-mirror

# 查看nginx版本
apt policy nginx
#nginx:
#  Installed: 1.10.3-0ubuntu0.16.04.4
#  Candidate: 1.10.3-0ubuntu0.16.04.4

# 安装nginx
sudo apt-get install nginx
```
## 2.配置文件
打开配置文件
```sh
sudo vi /etc/apt/mirror.list
```
一般只需要修改base_path以及相关版本的源
```ini
############# config ##################
#
# 设置数据根目录
set base_path    /home/mirror-data/apt-mirror
#
# set mirror_path  $base_path/mirror
# set skel_path    $base_path/skel
# set var_path     $base_path/var
# set cleanscript $var_path/clean.sh
# set defaultarch  <running host architecture>
# set postmirror_script $var_path/postmirror.sh
# set run_postmirror 0
# 20个线程同时下载
set nthreads     20
# 是否替换URL中的波浪线，替换成%7E（HTML代码），否则会跳过不进行下载
set _tilde 0
#
############# end config ##############

# 等会将会从这些网站上获取离线包，如果系统是64位，默认只下载离线的64位离线包；如果想更改,可以用deb-amd64和deb-i386
deb http://cn.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse
deb http://cn.archive.ubuntu.com/ubuntu/ xenial-updates main restricted universe multiverse
deb http://cn.archive.ubuntu.com/ubuntu/ xenial-proposed main restricted universe multiverse
deb http://cn.archive.ubuntu.com/ubuntu/ xenial-backports main restricted universe multiverse
deb http://security.ubuntu.com/ubuntu xenial-security main restricted universe multiverse

# deb-src http://cn.archive.ubuntu.com/ubuntu xenial main restricted universe multiverse
# deb-src http://cn.archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse
# deb-src http://cn.archive.ubuntu.com/ubuntu xenial-proposed main restricted universe multiverse
# deb-src http://cn.archive.ubuntu.com/ubuntu xenial-backports main restricted universe multiverse
# deb-src http://security.ubuntu.com/ubuntu xenial-security main restricted universe multiverse

clean http://cn.archive.ubuntu.com/ubuntu
clean http://security.ubuntu.com/ubuntu
```
保存后退出，然后执行
```sh
sudo apt-mirror
```
## 3.定时更新
`/etc/cron.d/apt-mirror` 中，取消最后一行的#注释即可生效：
```
0 4 * * * apt-mirror /usr/bin/apt-mirror > /var/spool/apt-mirror/var/cron.log
```
## 4.搭建nginx访问
修改配置文件
`sudo vi /etc/nginx/sites-enabled/default`
```ini
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
    listen 80 default_server;
    # listen [::]:80 default_server;

    # SSL configuration
    #
    # listen 443 ssl default_server;
    # listen [::]:443 ssl default_server;
    #
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332
    #
    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782
    #
    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    #
    # include snippets/snakeoil.conf;
    
    # 显示目录
    autoindex on;
    
    # 镜像所在的目录
    root /home/mirror-data/apt-mirror/mirror;

    # Add index.php to the list if you are using PHP
    index index.html index.htm index.nginx-debian.html;
    
    # 主机域名，填写localhost就是通过IP访问
    server_name 192.168.0.108;

    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        try_files $uri $uri/ =404;
    }
    
    # 访问记录
    access_log /home/mirror-data/apt-mirror.log;

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    include snippets/fastcgi-php.conf;
    #
    #    # With php7.0-cgi alone:
    #    fastcgi_pass 127.0.0.1:9000;
    #    # With php7.0-fpm:
    #    fastcgi_pass unix:/run/php/php7.0-fpm.sock;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny all;
    #}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#    listen 80;
#    listen [::]:80;
#
#    server_name example.com;
#
#    root /var/www/example.com;
#    index index.html;
#
#    location / {
#        try_files $uri $uri/ =404;
#    }
#}
```
保存配置后，测试：
```
sudo nginx -t
```
测试通过，则开启服务：
```sh
sudo service nginx restart
```
## 5.客户端更改源地址
`sudo vi /etc/apt/sources.list`
修改成该地址的源,如源的地址为：http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ ，则改为：
```
deb http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse

deb http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse

deb http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse

deb http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse

deb http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://192.168.152.139:8003/mirror/mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
```